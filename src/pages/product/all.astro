---
import Layout from '../../layouts/Layout.astro';
import Navbar from '../../components/Navbar/Navbar.astro';

// PERUBAHAN 1: Struktur data produk diubah total untuk mendukung desain kartu baru.
// Sekarang menyertakan harga per ukuran, jumlah suka, dan ulasan.
const products = [
    {
        brand: "Mykonos Dreamscape",
        name: "Eau de Parfum for Men",
        category: "men",
        image: "/images/dreamscape.jpeg",
        prices: { 2: 15000, 5: 30000, 10: 50000 },
        likes: 1376,
        rating: 5,
        reviews: 100
    },
    {
        brand: "Hawas Ice",
        name: "Eau de Parfum for Men",
        category: "men",
        image: "/images/hawas-ice.jpg",
        prices: { 2: 25000, 5: 60000, 10: 125000 },
        likes: 1723,
        rating: 5,
        reviews: 97
    },
    {
        brand: "Fleur Blossom",
        name: "Eau de Parfum For Women",
        category: "women",
        image: "/images/fleur-blossom.jpg",
        prices: { 2: 15000, 5: 30000, 10: 50000 },
        likes: 1207,
        rating: 5,
        reviews: 62
    },
    {
        brand: "Sharaf Blend",
        name: "Eau de Parfum",
        category: "unisex",
        image: "/images/sharaf-blend.jpg",
        prices: { 2: 20000, 5: 45000, 10: 85000 },
        likes: 1950,
        rating: 5,
        reviews: 215
    },
    {
        brand: "Escobar",
        name: "El Patrón's Choice",
        category: "men",
        image: "/images/escobar.jpg",
        prices: { 2: 30000, 5: 70000, 10: 135000 },
        likes: 2100,
        rating: 5,
        reviews: 250
    },
    {
        brand: "La Lune",
        name: "Eau de Soir",
        category: "women",
        image: "/images/la-lune.jpg",
        prices: { 2: 17000, 5: 34000, 10: 60000 },
        likes: 1150,
        rating: 4,
        reviews: 140
    },
    {
        brand: "Vice City",
        name: "Neon Nights",
        category: "men",
        image: "/images/vice-city.jpg",
        prices: { 2: 18000, 5: 38000, 10: 70000 },
        likes: 1400,
        rating: 4,
        reviews: 165
    },
    {
        brand: "Monaco Royale",
        name: "Casino Elixir",
        category: "unisex",
        image: "/images/monaco-royale.jpg",
        prices: { 2: 28000, 5: 65000, 10: 120000 },
        likes: 1680,
        rating: 5,
        reviews: 190
    },
    {
        brand: "Golden Age",
        name: "Timeless Classic",
        category: "unisex",
        image: "/images/golden-age.jpg",
        prices: { 2: 19000, 5: 40000, 10: 75000 },
        likes: 950,
        rating: 5,
        reviews: 110
    },
    {
        brand: "Scarlett Dreamy",
        name: "Sweet Fantasy",
        category: "women",
        image: "/images/scarlett-dreamy.jpg",
        prices: { 2: 16000, 5: 33000, 10: 55000 },
        likes: 1250,
        rating: 4,
        reviews: 130
    },
    {
        brand: "California",
        name: "Summer Breeze",
        category: "unisex",
        image: "/images/california.jpg",
        prices: { 2: 16000, 5: 32000, 10: 52000 },
        likes: 880,
        rating: 4,
        reviews: 95
    },
    {
        brand: "Poya",
        name: "Morning Dew",
        category: "women",
        image: "/images/poya.jpg",
        prices: { 2: 14000, 5: 28000, 10: 48000 },
        likes: 720,
        rating: 4,
        reviews: 85
    },
    {
        brand: "Loui",
        name: "Voyageur Intense",
        category: "men",
        image: "/images/loui.jpg",
        prices: { 2: 35000, 5: 80000, 10: 150000 },
        likes: 2500,
        rating: 5,
        reviews: 320
    },
    {
        brand: "Chno",
        name: "Eau de Femme",
        category: "women",
        image: "/images/chno.jpg",
        prices: { 2: 22000, 5: 50000, 10: 95000 },
        likes: 1800,
        rating: 5,
        reviews: 205
    },
    {
        brand: "Master Kids",
        name: "Gentle Cologne",
        category: "kids",
        image: "/images/master-kids.jpg",
        prices: { 2: 8000, 5: 15000, 10: 25000 },
        likes: 450,
        rating: 4,
        reviews: 60
    }
];
---

<Layout>
  <Navbar />
  <main>
    <section class="all-products">
      <div class="container">
        <h2>Semua Koleksi Decant</h2>
        <p class="section-subtitle">Pilih ukuran dan temukan aroma parfum premium favoritmu.</p>
        
        <div class="products-grid">
          {products.map(product => (
            <div 
              class="product-card" 
              data-product={JSON.stringify({
                brand: product.brand,
                name: product.name,
                image: product.image,
                prices: product.prices
              })}
            >
              <div class="product-image">
                <img src={product.image} alt={product.brand} />
              </div>
              <div class="product-info">
                <p class="brand">{product.brand}</p>
                <h3 class="product-name">{product.name}</h3>
                <p class="price">Rp {product.prices[2].toLocaleString('id-ID')}</p>
                <div class="ml-options">
                  <button class="ml-button active" data-ml="2">2ml</button>
                  <button class="ml-button" data-ml="5">5ml</button>
                  <button class="ml-button" data-ml="10">10ml</button>
                </div>
                <div class="actions">
                  <button class="add-to-cart">ADD TO CART</button>
                  <div class="likes">❤️ <span class="like-count">{product.likes}</span></div>
                </div>
                <div class="rating">
                  <span class="stars">{'⭐'.repeat(product.rating)}</span>
                  <span class="review-count">({product.reviews})</span>
                </div>
              </div>
            </div>
          ))}
        </div>
      </div>
    </section>
  </main>
</Layout>

<style>
  .all-products { padding: 4rem 2rem; background: #F8F6F4; }
  .container { max-width: 1200px; margin: 0 auto; }
  .all-products h2 { text-align: center; font-size: 2.5rem; color: #222; margin-bottom: 1rem; font-family: 'Playfair Display', serif; }
  .section-subtitle { text-align: center; font-size: 1.1rem; color: #666; margin-bottom: 3rem; font-family: 'Poppins', sans-serif; }
  .products-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 2.5rem; }
  .product-card {
    background: #fff;
    border-radius: 22px;
    box-shadow: 0 8px 32px rgba(191, 161, 129, 0.13);
    border: 1.5px solid #f0e8dd;
    transition: transform 0.22s, box-shadow 0.22s;
    overflow: hidden;
    display: flex;
    flex-direction: column;
  }
  .product-card:hover { transform: translateY(-10px); box-shadow: 0 18px 48px rgba(191, 161, 129, 0.19); }
  .product-image {
    width: 100%;
    height: 200px;
    background: linear-gradient(135deg, #f8f6f4 0%, #e3e3e3 100%);
  }
  .product-image img { width: 100%; height: 100%; object-fit: cover; }
  .product-info { padding: 1.5rem; text-align: center; display: flex; flex-direction: column; flex-grow: 1; }
  .brand { color: #bfa181; font-weight: 600; font-size: 1rem; margin-bottom: 0.2rem; letter-spacing: 0.5px; }
  .product-name { color: #222; margin-bottom: 1rem; font-size: 1.15rem; font-family: 'Playfair Display', serif; font-weight: 700; }
  .price { font-size: 1.3rem; font-weight: bold; color: #bfa181; margin-bottom: 1rem; }
  .ml-options { margin-bottom: 1.5rem; }
  .ml-button { background: #f8f6f4; color: #bfa181; border: 1px solid #e5d3b3; border-radius: 6px; padding: 0.3em 0.9em; margin: 0 0.15em; font-size: 0.95rem; font-weight: 500; cursor: pointer; transition: all 0.2s; }
  .ml-button.active, .ml-button:hover { background: linear-gradient(90deg, #bfa181 60%, #c9b37e 100%); color: #fff; border-color: #bfa181; }
  .actions { display: flex; justify-content: center; align-items: center; gap: 1rem; margin-top: auto; }
  .add-to-cart { background: linear-gradient(90deg, #bfa181 60%, #c9b37e 100%); color: #fff; border: none; padding: 0.7rem 1.2rem; border-radius: 8px; cursor: pointer; font-size: 0.9rem; font-weight: 600; transition: all 0.2s; }
  .add-to-cart:hover { transform: translateY(-2px); }
  .likes { color: #bfa181; font-size: 1rem; display: flex; align-items: center; }
  .rating { margin-top: 1rem; font-size: 1rem; color: #f5b041; }
  .review-count { color: #888; margin-left: 0.5rem; }
</style>

<script>
  import { addItemToCart } from '../../stores/cartStore.js';

  document.addEventListener('DOMContentLoaded', () => {
    function formatToRupiah(number: number): string {
      return 'Rp ' + Number(number).toLocaleString('id-ID');
    }

    const productCards = document.querySelectorAll<HTMLElement>('.product-card');

    productCards.forEach(card => {
      const priceElement = card.querySelector<HTMLElement>('.price');
      const sizeButtons = card.querySelectorAll<HTMLButtonElement>('.ml-button');
      const addToCartButton = card.querySelector<HTMLButtonElement>('.add-to-cart');
      
      // Get product data from JSON
      const productDataString = card.dataset.product;
      if (!productDataString) {
        console.error('Product data not found');
        return;
      }
      
      let productData;
      try {
        productData = JSON.parse(productDataString);
      } catch (error) {
        console.error('Error parsing product data:', error);
        return;
      }

      if (priceElement) {
        sizeButtons.forEach(button => {
          button.addEventListener('click', () => {
            sizeButtons.forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');

            const selectedSize = button.dataset.ml;
            if (selectedSize && productData.prices[selectedSize]) {
              const price = productData.prices[selectedSize];
              priceElement.textContent = formatToRupiah(price);
            }
          });
        });
      }

      if (addToCartButton) {
        addToCartButton.addEventListener('click', () => {
          const activeSizeButton = card.querySelector<HTMLButtonElement>('.ml-button.active');
          
          if (!activeSizeButton) {
            alert("Silakan pilih ukuran terlebih dahulu!");
            return;
          }

          const size = activeSizeButton.dataset.ml;
          
          if (!size || !productData.prices[size]) {
            console.error("Size atau harga tidak ditemukan");
            alert("Terjadi kesalahan, coba lagi.");
            return;
          }

          const itemToAdd = {
            brand: productData.brand,
            name: productData.name,
            image: productData.image,
            size: parseInt(size, 10),
            price: productData.prices[size]
          };

          console.log('Adding item to cart:', itemToAdd);

          try {
            addItemToCart(itemToAdd);
            
            // Feedback visual
            const originalText = addToCartButton.textContent;
            addToCartButton.textContent = 'Ditambahkan!';
            addToCartButton.style.background = '#22c55e';
            addToCartButton.disabled = true;

            setTimeout(() => {
              if (originalText) {
                addToCartButton.textContent = originalText;
              }
              addToCartButton.style.background = '';
              addToCartButton.disabled = false;
            }, 1200);
          } catch (error) {
            console.error('Error adding item to cart:', error);
            alert("Terjadi kesalahan saat menambahkan ke keranjang.");
          }
        });
      }
    });
  });
</script>